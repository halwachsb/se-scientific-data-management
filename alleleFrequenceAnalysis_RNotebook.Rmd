---
title: "gnomAD Data Processing and Visualization for ODC1 Gene"
author: "Bettina Halwachs-Wenzl (adapted)"
date: "October 8, 2025"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

## Purpose

This notebook processes variant call format (VCF) data from the **gnomAD exomes v4.1 for chromosome 2** to extract and visualize **Allele Frequencies (AF)** and **Allele Counts (AC)** for the coding region of the **ODC1 gene** (Ornithine Decarboxylase 1). The process involves using Bioconductor packages for genomic data handling and the `tidyverse` for data manipulation and plotting.

-----

## 1\. Setup and Library Loading

We'll load the necessary Bioconductor and general-purpose R packages.

```{r load_libraries}
# Load libraries - tell R with which function you wanna work
library(VariantAnnotation) # exploration and annotation of genetic variants
library(GenomicRanges) # representing genomic locations
library(GenomicFeatures) # For TxDb and mapping
library(AnnotationDbi)   # For the 'select' function
library(TxDb.Hsapiens.UCSC.hg38.knownGene) # R interface to a pre-fabricated database 
# of gene models for the human genome, 
# based on the UCSC hg38 assembly and the knownGene track.
library(org.Hs.eg.db) # the organism database package

library(data.table) # Extension of 'data.frame'. Fast aggregation of large data
library(RCurl) # Functions to fetch URIs
library(ggplot2) # The Chuck Norris of data visualization
library(dplyr) # facilitate manipulation of data frames
library(tidyr) # For data cleaning
library(tibble) # For better data frames
```

-----

## 2\. Define Target VCF and Gene Region

We specify the remote gnomAD VCF file and use Bioconductor to programmatically find the exact genomic coordinates for the **ODC1** gene's coding sequence (CDS).

### Define VCF Source

```{r define_vcf}
# Define the gnomAD VCF file for chromosome 2 (v4 exomes, GRCh38 coordinates)
gnomad_exome_chr2_vcf <- "https://storage.googleapis.com/gcp-public-data--gnomad/release/4.1/vcf/exomes/gnomad.exomes.v4.1.sites.chr2.vcf.bgz"
gnomad_exome_chr2_tbi <- paste0(gnomad_exome_chr2_vcf,".tbi")

# Optional: Add this line to prevent RMarkdown from trying to print the URL string
invisible(gnomad_exome_chr2_vcf)

```

### Get CDS Coordinates for ODC1

```{r get_cds_region}
#load the annotated reference genome into a variable
txdb <- TxDb.Hsapiens.UCSC.hg38.knownGene

gene_symbol <- "ODC1"

# CRITICAL: Explicitly call select from the AnnotationDbi package
gene_id_mapping <- AnnotationDbi::select(
  org.Hs.eg.db,
  keys = gene_symbol,
  keytype = "SYMBOL",
  columns = "ENTREZID"
)

print(gene_id_mapping)

gene_id <- gene_id_mapping$ENTREZID
#gene_id<-"4953" # The resulting ENTREZID is 4953

# 1. Get the CDS regions for the ODC1 gene (by gene ID)
cds_by_gene <- GenomicFeatures::cdsBy(txdb, by = "gene")

# Extract the CDS for our specific gene ID
odc1_cds_list <- cds_by_gene[[gene_id]]

# 2. Use reduce() to get the union of all non-overlapping coding exons
odc1_cds_reduced <- reduce(odc1_cds_list)

# 3. Process the results to get the overall genomic range for the Tabix query
chrom_cds <- as.character(seqnames(odc1_cds_reduced))[1]
strand_cds <- as.character(strand(odc1_cds_reduced))[1]
min_cds_start <- min(start(odc1_cds_reduced))
max_cds_end <- max(end(odc1_cds_reduced))

# 4. Create the final GRanges object for the full CDS region
target_range <- GRanges(
  seqnames = chrom_cds,
  ranges = IRanges(start = min_cds_start, end = max_cds_end),
  strand = strand_cds
)

print("New target range (encompassing ODC1 CDS region):")
print(target_range)
```

-----

## 3\. Stream and Process VCF Data

We use `TabixFile` and `readVcf` to stream only the relevant variants for the **ODC1** region and then extract the key **INFO** fields like Allele Frequency (AF) and Allele Count (AC).

```{r stream_and_extract_vcf}
# 1. Create a TabixFile object
tabix_file <- TabixFile(gnomad_exome_chr2_vcf, index=gnomad_exome_chr2_tbi)

# 2. Stream the VCF data for the ODC1 region
cat("Streaming data for ODC1 from gnomAD exomes VCF...\n")
vcf_odc1 <- readVcf(tabix_file, genome = "GRCh38", param = target_range)
cat(paste("Successfully imported", nrow(vcf_odc1), "variants in the ODC1 region.\n"))

# 3. Extract the INFO field and genomic coordinates
info_df <- as.data.frame(info(vcf_odc1))

# 4. Create a base data frame for results
results_odc1 <- data.frame(
  CHROM = as.character(seqnames(vcf_odc1)),
  POS = start(vcf_odc1),
  REF = as.character(ref(vcf_odc1)),
  ALT = unlist(lapply(alt(vcf_odc1), paste, collapse=",")), # Handle multi-allelic ALTs
  ID = names(vcf_odc1)
)

# 5. Extract AF, AC, and AN and combine results
af_list <- info_df$AF
af_df <- as.data.frame(do.call(rbind, af_list))
colnames(af_df) <- paste0("AF_ALT", 1:ncol(af_df))

ac_list <- info_df$AC
ac_df <- as.data.frame(do.call(rbind, ac_list))
colnames(ac_df) <- paste0("AC_ALT", 1:ncol(ac_df))

an_vector <- info_df$AN

results_odc1 <- cbind(results_odc1, af_df, ac_df, AN=an_vector)

# Sanity check for the first allele's AF
results_odc1$Calculated_AF_ALT1 <- results_odc1$AC_ALT1 / results_odc1$AN
results_odc1$AF_Difference <- abs(results_odc1$AF_ALT1 - results_odc1$Calculated_AF_ALT1)

# Format for cleaner output
results_odc1$AF_ALT1 <- round(results_odc1$AF_ALT1, 5)
results_odc1$Calculated_AF_ALT1 <- round(results_odc1$Calculated_AF_ALT1, 5)
results_odc1$AF_Difference <- round(results_odc1$AF_Difference, 6)

# Select and display the most relevant columns
final_output <- results_odc1[, c("CHROM", "POS", "ID", "REF", "ALT", "AC_ALT1", "AN", "AF_ALT1")]

cat("\n## Filtered Allele Frequencies for ODC1 (Top 30 variants) ##\n")
print(head(final_output[order(final_output$POS), ], 30))
```

-----

## 4\. Data Preparation for Plotting

The data must be re-structured using `tidyr::unnest` to properly handle multi-allelic sites for `ggplot2`. This process combines all coordinate, fixed, and INFO data.

```{r data_prep_plotting}
# 1. Extract and convert INFO data to a tibble
info_data <- info(vcf_odc1)
info_df <- as_tibble(info_data) 

# 2. Extract fixed columns (REF, ALT)
fixed_data <- fixed(vcf_odc1)
fixed_df <- tibble(
  REF = as.character(fixed_data$REF),
  ALT = lapply(fixed_data$ALT, as.character) 
)

# 3. Extract variant coordinates and rs IDs
variant_ranges <- rowRanges(vcf_odc1)
variant_df <- tibble(
  seqnames = as.character(seqnames(variant_ranges)),
  start = start(variant_ranges),
  end = end(variant_ranges),
  rsID = names(variant_ranges) 
) 

# 4. Combine ALL data sources and unnest the list columns (ALT, AF, AC)
all_data <- bind_cols(variant_df, fixed_df, info_df) %>%
  
  # CRITICAL: Unnest ALL list-columns needed for plotting 
  unnest(cols = c(ALT, AF, AC)) %>% 
  
  mutate(
    # Ensure AC is numeric
    AC = as.numeric(AC),
    # Create unique Variant ID
    Variant_ID = paste0(seqnames, ":", start, ":", REF, ">", ALT)
  )

# 5. Filter for the top 30 most frequent alternate alleles (AF > 0)
frequent_alleles <- all_data %>%
  filter(AF > 0) %>%
  arrange(desc(AF)) %>%
  head(30) %>%
  # Create a cleaner label for the plot
  mutate(Label = paste0(Variant_ID, " (", rsID, ") - ", round(AF * 100, 1), "%"))

cat("\nSuccessfully processed and filtered data for plotting:\n")
print(frequent_alleles)
```

-----

## 5\. Visualization with ggplot2

We generate several plots to visualize the distribution of allele frequencies, variant density, and the relationship between Allele Count and Allele Frequency.

### Top 30 Most Frequent Alleles (Bar Plot)

```{r bar_plot, fig.height=6, fig.width=8}
allele_plot <- ggplot(frequent_alleles, aes(x = reorder(Variant_ID, -AF), y = AF)) +
  geom_bar(stat = "identity", fill = "#0072B2") +
  geom_text(aes(label = paste0(round(AF * 100, 1), "%")), 
            vjust = -0.5, size = 2) +
  labs(
    title = paste("Top 30 Most Frequent Alleles in ODC1 (EntrezID: 4953)"),
    x = "Variant ID (CHROM:POS:REF>ALT)",
    y = "Allele Frequency (AF)"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 6),
    plot.title = element_text(hjust = 0.5)
  )

allele_plot

# Save the plot
# ggsave("most_frequent_alleles_ODC1.png", plot = allele_plot, width = 8, height = 6)
```

```
```
